variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"
  BACKEND_IMAGE: "$CI_REGISTRY_IMAGE/backend"
  FRONTEND_IMAGE: "$CI_REGISTRY_IMAGE/frontend"
  COMMIT_TAG: "$CI_COMMIT_SHORT_SHA"
  LATEST_TAG: "latest"

stages:
  - build
  - test
  - docker-build
  - docker-push
  - sonarqube-check

# ---------- BUILD ----------
build:
  stage: build
  image: gradle:8.7-jdk21-alpine
  script:
    - cd back-end
    - ./gradlew assemble --no-daemon
  artifacts:
    paths:
      - back-end/build
    expire_in: 1h

# ---------- TEST (Backend + Postgres service) ----------
test:
  stage: test
  image: gradle:8.7-jdk21-alpine
  services:
    - name: postgres:16
      alias: postgres
  variables:
    POSTGRES_DB: appdb
    POSTGRES_USER: appuser
    POSTGRES_PASSWORD: secret
    # Spring Test will read these if you map them in application-*.yml or @DynamicPropertySource
    SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/appdb
    SPRING_DATASOURCE_USERNAME: appuser
    SPRING_DATASOURCE_PASSWORD: secret
  script:
    - cd back-end
    - ./gradlew test --no-daemon

# ---------- (Optional) Frontend build/test ----------
frontend:test:
  stage: test
  image: node:20-alpine
  script:
    - cd front-end
    - npm ci
    - npm run build
    # add: npm test -- --watchAll=false  (if you have tests)

# ---------- DOCKER BUILD (uses DinD only for these jobs) ----------
backend:docker-build:
  stage: docker-build
  image: docker:25
  services: ["docker:25-dind"]
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_BUILDKIT: "1"
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - docker build -t "$BACKEND_IMAGE:$COMMIT_TAG" back-end

frontend:docker-build:
  stage: docker-build
  image: docker:25
  services: ["docker:25-dind"]
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_BUILDKIT: "1"
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - docker build -t "$FRONTEND_IMAGE:$COMMIT_TAG" front-end

# ---------- PUSH (default branch only) ----------
backend:docker-push:
  stage: docker-push
  image: docker:25
  services: ["docker:25-dind"]
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - docker push "$BACKEND_IMAGE:$COMMIT_TAG"
    - docker tag "$BACKEND_IMAGE:$COMMIT_TAG" "$BACKEND_IMAGE:$LATEST_TAG"
    - docker push "$BACKEND_IMAGE:$LATEST_TAG"

frontend:docker-push:
  stage: docker-push
  image: docker:25
  services: ["docker:25-dind"]
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - docker push "$FRONTEND_IMAGE:$COMMIT_TAG"
    - docker tag "$FRONTEND_IMAGE:$COMMIT_TAG" "$FRONTEND_IMAGE:$LATEST_TAG"
    - docker push "$FRONTEND_IMAGE:$LATEST_TAG"

# ---------- SONAR (placeholder you had) ----------
sonarqube-check:
  stage: sonarqube-check
  image: alpine:3.20
  script:
    - echo "This is a demo stage replacing SonarQube analysis."
