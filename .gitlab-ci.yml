variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"

stages:
  - build
  - test
  - sonarqube-check

.before_java: &before_java
  # (Optional) ensure this runs on your Windows runner
  # tags:
  #   - windows
  before_script:
    - |
      # PowerShell setup for Java
      $jdk = Get-ChildItem 'C:\Program Files\Eclipse Adoptium' -Directory -Filter 'jdk*' |
        Sort-Object Name -Descending |
        Select-Object -First 1 -ExpandProperty FullName
      if (-not $jdk) { throw "No JDK found under C:\ Program Files\Eclipse Adoptium" }
      $env:JAVA_HOME = $jdk
      $env:Path = "$env:JAVA_HOME\bin;$env:Path"
      Write-Host "Using JAVA_HOME = $env:JAVA_HOME"
      java -version

      # Locate the Gradle wrapper (prefer Windows .bat)
      $proj = $env:CI_PROJECT_DIR
      if (Test-Path "$proj\gradlew.bat") {
        $env:GRADLEW = "$proj\gradlew.bat"
      } elseif (Test-Path "$proj\gradlew") {
        # Fallback: POSIX script present (less ideal on Windows)
        $env:GRADLEW = "$proj\gradlew"
      } else {
        throw "Gradle wrapper not found. Commit gradlew/gradlew.bat and gradle/wrapper/*"
      }

      # Show Gradle version
      & $env:GRADLEW --version

build:
  stage: build
  <<: *before_java
  script:
    - '& $env:GRADLEW assemble'

test:
  stage: test
  <<: *before_java
  script:
    - '& $env:GRADLEW test'

sonarqube-check:
  stage: sonarqube-check
  <<: *before_java
  script:
    - echo "This is a demo stage replacing SonarQube analysis."
