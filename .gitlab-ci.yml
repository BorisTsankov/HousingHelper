stages:
  - lint
  - test
  - build
  - package
  - deploy

# -------- Common anchors (DRY) --------
.default-docker:
  image: alpine:3.20
  before_script:
    - apk add --no-cache bash curl git coreutils

# Frontend base image (Node 18 LTS)
.node:
  image: node:18-bullseye
  cache:
    key:
      files:
        - frontend/package-lock.json
    paths:
      - frontend/node_modules/
  before_script:
    - cd frontend
    - node -v
    - npm ci

# Backend base image (Temurin JDK 21 + Gradle wrapper)
.gradle:
  image: eclipse-temurin:21-jdk
  variables:
    GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"
  cache:
    key:
      files:
        - backend/gradle/wrapper/gradle-wrapper.properties
        - backend/build.gradle
      prefix: gradle-cache
    paths:
      - .gradle/wrapper
      - .gradle/caches
  before_script:
    - cd backend
    - java -version
    - chmod +x ./gradlew

# -------- FRONTEND JOBS --------
frontend:lint:
  stage: lint
  extends: [.node]
  rules:
    - changes:
        - frontend/**/*
  script:
    - npm run lint

frontend:test:
  stage: test
  extends: [.node]
  needs: ["frontend:lint"]
  rules:
    - changes:
        - frontend/**/*
  script:
    - npm test -- --ci --watchAll=false

frontend:build:
  stage: build
  extends: [.node]
  needs: ["frontend:test"]
  rules:
    - changes:
        - frontend/**/*
  script:
    - npm run build
  artifacts:
    paths:
      - frontend/build
    expire_in: 3 days

# Optional: build a Docker image for the frontend (static file server, Nginx, etc.)
frontend:package:
  stage: package
  extends: [.default-docker]
  needs: ["frontend:build"]
  rules:
    - if: $CI_COMMIT_BRANCH
      changes:
        - frontend/**/*
  variables:
    IMAGE_NAME: "$CI_REGISTRY_IMAGE/frontend"
    IMAGE_TAG: "${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
  script:
    - echo "Logging in to GitLab Registry"
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - docker build -t "$IMAGE_NAME:$IMAGE_TAG" -f frontend/Dockerfile .
    - docker push "$IMAGE_NAME:$IMAGE_TAG"

# -------- BACKEND JOBS --------
backend:lint:
  stage: lint
  extends: [.gradle]
  rules:
    - changes:
        - backend/**/*
  script:
    # If you use Spotless/Checkstyle/PMD; adjust accordingly
    - ./gradlew spotlessCheck || ./gradlew checkstyleMain checkstyleTest

backend:test:
  stage: test
  extends: [.gradle]
  needs: ["backend:lint"]
  rules:
    - changes:
        - backend/**/*
  script:
    - ./gradlew test
  artifacts:
    when: always
    reports:
      junit: backend/build/test-results/test/*.xml

backend:build:
  stage: build
  extends: [.gradle]
  needs: ["backend:test"]
  rules:
    - changes:
        - backend/**/*
  script:
    - ./gradlew clean bootJar
  artifacts:
    paths:
      - backend/build/libs/*.jar
    expire_in: 3 days

# Optional: build a Docker image for the backend
backend:package:
  stage: package
  extends: [.default-docker]
  needs: ["backend:build"]
  rules:
    - if: $CI_COMMIT_BRANCH
      changes:
        - backend/**/*
  variables:
    IMAGE_NAME: "$CI_REGISTRY_IMAGE/backend"
    IMAGE_TAG: "${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
  script:
    - echo "Logging in to GitLab Registry"
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - docker build -t "$IMAGE_NAME:$IMAGE_TAG" -f backend/Dockerfile .
    - docker push "$IMAGE_NAME:$IMAGE_TAG"

# -------- Optional deploy placeholders --------
deploy:staging:
  stage: deploy
  extends: [.default-docker]
  needs: ["backend:package", "frontend:package"]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  script:
    - echo "Deploy your images $CI_REGISTRY_IMAGE/backend and /frontend to staging here (kubectl/ssh/ansible/etc.)"
