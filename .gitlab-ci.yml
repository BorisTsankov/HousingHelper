# Global
stages:
  - test
  - build
  - sonar
  - integration-test  # optional, only if triggered

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH
      changes:
        - "**/*"
      except:
        - "**/*.md"
        - "docs/**/*"
    - when: always

variables:
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  GIT_DEPTH: "1"
  GRADLE_USER_HOME: "${CI_PROJECT_DIR}/.gradle"
  FRONTEND_SONAR_PROJECT_KEY: "I547859_housinghelper_ae8e7364-5047-4633-b1b8-b09df4130bef"
  BACKEND_SONAR_PROJECT_KEY: "I547859_housinghelper_backend"

.sonar-diagnostics:
  before_script:
    - |
      # ===== Sonar Diagnostics (portable, no Python) =====
      set -euo pipefail

      echo "===== Sonar Diagnostics ====="
      echo "Runner: $(uname -a)"
      echo "Node:   $(hostname -f || hostname)"
      echo "Time (container): $(date -u '+%Y-%m-%dT%H:%M:%SZ')"

      echo "SONAR_HOST_URL=${SONAR_HOST_URL:-<unset>}"
      echo "Proxy env:"
      env | grep -i -E '^(http|https|no)_proxy=' || echo "<no proxy env>"

      if [ -z "${SONAR_HOST_URL:-}" ]; then
        echo "ERROR: SONAR_HOST_URL is not set"; exit 2
      fi

      RAW_URL="${SONAR_HOST_URL}"
      case "$RAW_URL" in
        http://*|https://*) URL="$RAW_URL" ;;
        *) URL="http://$RAW_URL" ;;
      esac
      PROTO="${URL%%://*}"
      REST="${URL#*://}"
      HOSTPORT="${REST%%/*}"
      PATHPART="/${REST#"$HOSTPORT"}"
      [ "$PATHPART" = "/$REST" ] && PATHPART="/"
      if echo "$HOSTPORT" | grep -q ':'; then
        HOST="${HOSTPORT%%:*}"
        PORT="${HOSTPORT#*:}"
      else
        HOST="$HOSTPORT"
        if [ "$PROTO" = "https" ]; then PORT="443"; else PORT="80"; fi
      fi
      echo "Parsed URL -> scheme=${PROTO} host=${HOST} port=${PORT} path=${PATHPART}"
      [ -z "$HOST" ] && { echo "ERROR: Missing hostname"; exit 2; }
      [ "$PROTO" != "http" ] && [ "$PROTO" != "https" ] && { echo "ERROR: Invalid scheme"; exit 2; }

      # Tooling (Alpine or Debian/Ubuntu)
      if command -v apk >/dev/null 2>&1; then
        apk add --no-cache curl jq bind-tools iputils busybox-extras openssl ca-certificates >/dev/null
      elif command -v apt-get >/dev/null 2>&1; then
        apt-get update -y >/dev/null
        DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
          curl jq dnsutils iputils-ping netcat-openbsd openssl ca-certificates >/dev/null
      fi

      echo "----- /etc/hosts -----"; cat /etc/hosts || true
      echo "----- resolv.conf -----"; cat /etc/resolv.conf || true

      echo "DNS getent:"; if command -v getent >/dev/null 2>&1; then getent hosts "$HOST" || echo "getent failed"; else echo "getent not available"; fi
      echo "nslookup:"; if command -v nslookup >/dev/null 2>&1; then nslookup "$HOST" || echo "nslookup failed"; else echo "nslookup not available"; fi

      echo "Ping:"; if command -v ping >/dev/null 2>&1; then ping -c 1 -W 2 "$HOST" || echo "ping failed (may be blocked)"; else echo "ping not available"; fi

      echo "TCP connect (nc):"; if command -v nc >/dev/null 2>&1; then nc -vz -w 5 "$HOST" "$PORT" || echo "nc failed"; else echo "nc not available"; fi

      if [ "$PROTO" = "https" ] && command -v openssl >/dev/null 2>&1; then
        echo "TLS handshake (openssl s_client):"
        echo | openssl s_client -servername "$HOST" -connect "${HOST}:${PORT}" -brief 2>/dev/null || echo "openssl s_client failed"
      fi

      BASE="${SONAR_HOST_URL%/}"
      echo "HTTP probe /api/system/status:"
      curl -sv -m 10 "${BASE}/api/system/status" -o >(tee /tmp/sonar_status.json) -w "\nHTTP_CODE:%{http_code}\n" || true

      echo "Server-Time header vs container time (clock skew check):"
      curl -sI -m 10 "${BASE}" | awk -F': ' 'tolower($1)=="date"{print "Server Date: "$2}'
      echo "Container Date: $(date -u '+%Y-%m-%dT%H:%M:%SZ')"

      TOK="${SONAR_TOKEN:-${SONAR_USER_TOKEN:-}}"
      if [ -z "$TOK" ]; then
        echo "WARNING: No SONAR_USER_TOKEN/SONAR_TOKEN set"
      else
        echo "Token present (length ${#TOK}), starts with: ${TOK:0:4}****"
        echo "Auth validate:"
        curl -s -u "${TOK}:" -o /dev/null -w "HTTP_CODE:%{http_code}\n" "${BASE}/api/authentication/validate" || true
      fi

      echo "Server version:"
      curl -s "${BASE}/api/server/version" || echo "<failed>"

      echo -e "\nInstalled plugins (first 10):"
      curl -s "${BASE}/api/plugins/installed" | jq '.plugins | .[0:10] | [.[]|{key,name,version}]' || echo "<failed>"

      if [ -n "$TOK" ]; then
        echo -e "\nProject (frontend) visible?"
        curl -s -u "${TOK}:" "${BASE}/api/projects/search?projects=${FRONTEND_SONAR_PROJECT_KEY}" | jq '.components | length, .[0].key' || true
        echo "Project (backend) visible?"
        curl -s -u "${TOK}:" "${BASE}/api/projects/search?projects=${BACKEND_SONAR_PROJECT_KEY}" | jq '.components | length, .[0].key' || true
      fi

      echo "===== End Sonar Diagnostics ====="



# ---------- FRONTEND ----------
.default-node:
  image: node:20-bullseye
  variables:
    NPM_CONFIG_CACHE: "$CI_PROJECT_DIR/.npm"
  cache:
    key:
      files:
        - front-end/package-lock.json
    paths:
      - front-end/node_modules/
      - .npm/
  before_script:
    - cd front-end
    - node -v
    - npm ci --no-audit --no-fund

test:frontend:
  stage: test
  extends: .default-node
  script:
    - if npm run | grep -qE '^[[:space:]]*test'; then npm run test -- --ci --watchAll=false --coverage; else echo "No npm test script. Skipping."; fi
  artifacts:
    when: always
    reports:
      junit: front-end/junit/*.xml
    paths:
      - front-end/coverage/lcov.info

build:frontend:
  stage: build
  extends: .default-node
  script:
    - npm run build
  artifacts:
    paths:
      - front-end/dist
    expire_in: 3 days
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_TAG'

sonar:frontend:
  stage: sonar
  image: sonarsource/sonar-scanner-cli:latest
  needs: ["test:frontend"]
  variables:
    SONAR_TOKEN: "$SONAR_USER_TOKEN"
    SONAR_SCANNER_OPTS: "-Dsonar.qualitygate.wait=false"
  extends: .sonar-diagnostics
  before_script:
    - cd front-end
    - !reference [.sonar-diagnostics, before_script]
  script:
    - |
      sonar-scanner \
        -Dsonar.projectKey="${FRONTEND_SONAR_PROJECT_KEY}" \
        -Dsonar.projectName=frontend \
        -Dsonar.sources=src \
        -Dsonar.tests=src \
        -Dsonar.test.inclusions="**/*.spec.ts,**/*.spec.tsx,**/*.test.ts,**/*.test.tsx,**/*.spec.js,**/*.test.js" \
        -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info \
        -Dsonar.host.url="${SONAR_HOST_URL}" \
        -Dsonar.token="${SONAR_TOKEN}"
  allow_failure: true
  rules:
    - if: '$RUN_SONAR != "false"'

# ---------- BACKEND ----------
.default-gradle:
  image: gradle:8.10.0-jdk17-jammy
  variables:
    GRADLE_OPTS: "-Dorg.gradle.jvmargs='-Xmx2g' -Dorg.gradle.parallel=true -Dorg.gradle.configuration-cache=true -Dorg.gradle.caching=true"
  cache:
    policy: pull-push
    key:
      files:
        - back-end/gradle/wrapper/gradle-wrapper.properties
        - back-end/gradle.properties
    paths:
      - ".gradle/caches"
      - ".gradle/wrapper"
      - "${SONAR_USER_HOME}/cache"
  before_script:
    - cd back-end
    - java -version
    - gradle --version

test:backend:
  stage: test
  extends: .default-gradle
  script:
    - gradle --no-daemon test jacocoTestReport --build-cache --parallel --configure-on-demand
  artifacts:
    when: always
    reports:
      junit: back-end/build/test-results/test/*.xml
    paths:
      - back-end/build/reports/jacoco/test/jacocoTestReport.xml

build:backend:
  stage: build
  extends: .default-gradle
  needs: ["test:backend"]
  script:
    - gradle --no-daemon assemble --build-cache --parallel --configure-on-demand
  artifacts:
    paths:
      - back-end/build/libs/*.jar
    expire_in: 3 days
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_TAG'

sonar:backend:
  stage: sonar
  extends:
    - .default-gradle
  needs: ["test:backend"]
  variables:
    SONAR_TOKEN: "$SONAR_USER_TOKEN"
  before_script:
    - cd back-end
    - !reference [.sonar-diagnostics, before_script]
  script:
    - |
      gradle --no-daemon jacocoTestReport sonarqube --build-cache --parallel --configure-on-demand \
        -Dsonar.host.url="${SONAR_HOST_URL}" \
        -Dsonar.token="${SONAR_TOKEN}" \
        -Dsonar.projectKey="${BACKEND_SONAR_PROJECT_KEY}" \
        -Dsonar.coverage.jacoco.xmlReportPaths=build/reports/jacoco/test/jacocoTestReport.xml \
        -Dsonar.java.binaries=build/classes/java/main,build/classes/kotlin/main \
        -Dsonar.qualitygate.wait=false
  allow_failure: true
  rules:
    - if: '$RUN_SONAR != "false"'

# Optional targeted diagnostics (no scan) â€” run manually
debug:sonar:
  stage: sonar
  image: sonarsource/sonar-scanner-cli:latest
  variables:
    SONAR_TOKEN: "$SONAR_USER_TOKEN"
  extends: .sonar-diagnostics
  script:
    - echo "Diagnostics done. Not running scanner."
  rules:
    - if: '$RUN_SONAR_DEBUG == "true"'

debug:net:
  image: busybox:1.36
  script:
    - echo "Expect to resolve 'sonarqube' on ci-net"
    - cat /etc/resolv.conf || true
    - cat /etc/hosts || true
    - nslookup sonarqube || ping -c 1 sonarqube || true

# ---------- OPTIONAL: Integration tests with real Postgres ----------
integration-test:backend:
  stage: integration-test
  image: gradle:8.10.0-jdk17-jammy
  services:
    - name: postgres:16-alpine
      alias: postgres
  variables:
    POSTGRES_DB: appdb
    POSTGRES_USER: app
    POSTGRES_PASSWORD: secret
    SPRING_DATASOURCE_URL: "jdbc:postgresql://postgres:5432/appdb"
    SPRING_DATASOURCE_USERNAME: "app"
    SPRING_DATASOURCE_PASSWORD: "secret"
    SPRING_FLYWAY_URL: "jdbc:postgresql://postgres:5432/appdb"
    SPRING_FLYWAY_USER: "app"
    SPRING_FLYWAY_PASSWORD: "secret"
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "1"
    GRADLE_USER_HOME: "${CI_PROJECT_DIR}/.gradle"
  cache:
    policy: pull-push
    key:
      files:
        - back-end/gradle/wrapper/gradle-wrapper.properties
        - back-end/gradle.properties
    paths:
      - ".gradle/caches"
      - ".gradle/wrapper"
  before_script:
    - cd back-end
    - apt-get update -y >/dev/null && apt-get install -y postgresql-client >/dev/null
    - until pg_isready -h postgres -p 5432 -U "$POSTGRES_USER"; do echo "Waiting for Postgres..."; sleep 1; done
  script:
    - gradle --no-daemon clean test jacocoTestReport --build-cache --parallel --configure-on-demand
  rules:
    - if: '$RUN_INTEGRATION_TESTS == "true"'
