variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"

stages:
  - build
  - test
  - sonarqube-check

# ---------- shared anchors ----------
.default-node:
  image: node:20-bullseye   # ← Node 20 to satisfy vite/react-router engines
  cache:
    key: npm-cache
    paths:
      - front-end/node_modules/
  before_script:
    - cd front-end
    - node -v
    - npm ci

.default-gradle:
  image: eclipse-temurin:17-jdk   # ← JDK 17 to match Gradle toolchain requirement
  variables:
    GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"
  cache:
    key: gradle-cache
    paths:
      - .gradle/wrapper
      - .gradle/caches
  before_script:
    - cd back-end
    - java -version
    - chmod +x ./gradlew

# ================= FRONT-END =================
build:frontend:
  stage: build
  extends: [.default-node]
  script:
    - npm run build
  artifacts:
    paths:
      - front-end/dist    # ← vite default output
    expire_in: 3 days

test:frontend:
  stage: test
  extends: [.default-node]
  needs: ["build:frontend"]
  script:
    # Run tests only if a "test" script exists; otherwise skip gracefully
    - if npm run | grep -qE '^[[:space:]]*test'; then npm run test -- --ci --watchAll=false; else echo "No npm test script. Skipping."; fi
  artifacts:
    when: always
    # If you export JUnit from your test runner, point this to the correct path
    reports:
      junit: front-end/junit/*.xml

sonarqube-check:frontend:
  stage: sonarqube-check
  image: alpine:3.20
  needs: ["test:frontend"]
  script:
    - echo "Frontend Sonar placeholder — replace with 'sonar-scanner' if configured."

# ================= BACK-END =================
build:backend:
  stage: build
  extends: [.default-gradle]
  script:
    - ./gradlew assemble
  artifacts:
    paths:
      - back-end/build/libs/*.jar
    expire_in: 3 days

test:backend:
  stage: test
  extends: [.default-gradle]
  needs: ["build:backend"]
  script:
    - ./gradlew test
  artifacts:
    when: always
    reports:
      junit: back-end/build/test-results/test/*.xml

sonarqube-check:backend:
  stage: sonarqube-check
  image: alpine:3.20
  needs: ["test:backend"]
  script:
    - echo "Backend Sonar placeholder — replace with './gradlew sonarqube' when ready."
