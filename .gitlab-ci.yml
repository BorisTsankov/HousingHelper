stages:
  - lint
  - test
  - build
  - package
  - deploy

# ---------- shared bits ----------
.default-docker:
  image: alpine:3.20
  before_script:
    - apk add --no-cache bash curl git coreutils

# FRONT-END (React + TS, Node 18)
.node:
  image: node:18-bullseye
  cache:
    key: "npm-cache"
    paths:
      - front-end/node_modules/
  before_script:
    - cd front-end
    - node -v
    - npm ci

# BACK-END (Spring Boot + Gradle wrapper, JDK 21)
.gradle:
  image: eclipse-temurin:21-jdk
  variables:
    GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"
  cache:
    key: "gradle-cache"
    paths:
      - .gradle/wrapper
      - .gradle/caches
  before_script:
    - cd back-end
    - java -version
    - chmod +x ./gradlew

# ================= FRONT-END =================
frontend:lint:
  stage: lint
  extends: [.node]
  script:
    - npm run lint

frontend:test:
  stage: test
  extends: [.node]
  needs: ["frontend:lint"]
  script:
    - npm test -- --ci --watchAll=false

frontend:build:
  stage: build
  extends: [.node]
  needs: ["frontend:test"]
  script:
    - npm run build
  artifacts:
    paths:
      - front-end/build
    expire_in: 3 days

frontend:package:
  stage: package
  extends: [.default-docker]
  needs: ["frontend:build"]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG'
    - when: never
  variables:
    IMAGE_NAME: "$CI_REGISTRY_IMAGE/frontend"
    IMAGE_TAG: "${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - docker build -t "$IMAGE_NAME:$IMAGE_TAG" -f front-end/Dockerfile .
    - docker push "$IMAGE_NAME:$IMAGE_TAG"

# ================= BACK-END =================
backend:lint:
  stage: lint
  extends: [.gradle]
  script:
    # tweak if you're not using these linters
    - ./gradlew spotlessCheck || ./gradlew checkstyleMain checkstyleTest

backend:test:
  stage: test
  extends: [.gradle]
  needs: ["backend:lint"]
  script:
    - ./gradlew test
  artifacts:
    when: always
    reports:
      junit: back-end/build/test-results/test/*.xml

backend:build:
  stage: build
  extends: [.gradle]
  needs: ["backend:test"]
  script:
    - ./gradlew clean bootJar
  artifacts:
    paths:
      - back-end/build/libs/*.jar
    expire_in: 3 days

backend:package:
  stage: package
  extends: [.default-docker]
  needs: ["backend:build"]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG'
    - when: never
  variables:
    IMAGE_NAME: "$CI_REGISTRY_IMAGE/backend"
    IMAGE_TAG: "${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - docker build -t "$IMAGE_NAME:$IMAGE_TAG" -f back-end/Dockerfile .
    - docker push "$IMAGE_NAME:$IMAGE_TAG"

# ================= DEPLOY =================
deploy:staging:
  stage: deploy
  extends: [.default-docker]
  needs:
    - backend:package
    - frontend:package
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - when: never
  script:
    - echo "Deploy $CI_REGISTRY_IMAGE/backend and $CI_REGISTRY_IMAGE/frontend ..."
