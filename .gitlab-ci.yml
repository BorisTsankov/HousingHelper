# Global
stages:
  - build
  - test
  - sonar
  - integration-test  # optional, runs only if you trigger it

variables:
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  GIT_DEPTH: "0"
  GRADLE_USER_HOME: "${CI_PROJECT_DIR}/.gradle"
  FRONTEND_SONAR_PROJECT_KEY: "I547859_housinghelper_ae8e7364-5047-4633-b1b8-b09df4130bef"
  BACKEND_SONAR_PROJECT_KEY: "I547859_housinghelper_backend"

# ---------- FRONTEND ----------
.default-node:
  image: node:20-bullseye
  cache:
    # Faster & more stable cache reuse across branches based on lockfile
    key:
      files:
        - front-end/package-lock.json
    paths:
      - front-end/node_modules/
      - front-end/.npm/
  before_script:
    - cd front-end
    - node -v
    # use a local npm cache + skip audit/fund for speed
    - npm config set cache .npm --location=project
    - npm ci --no-audit --no-fund

build:frontend:
  stage: build
  extends: .default-node
  script:
    - npm run build
  artifacts:
    paths:
      - front-end/dist
    expire_in: 3 days

test:frontend:
  stage: test
  extends: .default-node
  needs: [ "build:frontend" ]
  script:
    # if there's a test script, run it in CI mode without watch; use coverage output
    - if npm run | grep -qE '^[[:space:]]*test'; then npm run test -- --ci --watchAll=false --coverage; else echo "No npm test script. Skipping."; fi
  artifacts:
    when: always
    reports:
      junit: front-end/junit/*.xml
    paths:
      - front-end/coverage/lcov.info

# ---------- Sonar SMOKE CHECK (tiny, fast) ----------
sonar:smoke:
  stage: sonar
  image: curlimages/curl:8.10.1
  variables:
    SONAR_TOKEN: "$SONAR_USER_TOKEN"
  script:
    - |
      set -euo pipefail
      echo "Pinging SonarQube at ${SONAR_HOST_URL}"
      # 1) basic status (no auth)
      STATUS_JSON="$(curl -sS --connect-timeout 3 --retry 2 --retry-connrefused "${SONAR_HOST_URL}/api/system/status")"
      echo "Status: ${STATUS_JSON:-<no response>}"
      echo "$STATUS_JSON" | grep -q '"status":"UP"' || { echo "SonarQube not UP"; exit 1; }
      # 2) auth validation with token
      AUTH_JSON="$(curl -sS -u "${SONAR_TOKEN}:" "${SONAR_HOST_URL}/api/authentication/validate")"
      echo "$AUTH_JSON" | grep -q '"valid":true' || { echo "Sonar token invalid or missing rights"; exit 1; }
      # 3) token can see both projects (visibility check)
      curl -sf -u "${SONAR_TOKEN}:" "${SONAR_HOST_URL}/api/projects/search?projects=${FRONTEND_SONAR_PROJECT_KEY}" \
        | grep -q "\"key\":\"${FRONTEND_SONAR_PROJECT_KEY}\"" \
        || { echo "Token cannot see frontend project ${FRONTEND_SONAR_PROJECT_KEY}"; exit 1; }
      curl -sf -u "${SONAR_TOKEN}:" "${SONAR_HOST_URL}/api/projects/search?projects=${BACKEND_SONAR_PROJECT_KEY}" \
        | grep -q "\"key\":\"${BACKEND_SONAR_PROJECT_KEY}\"" \
        || { echo "Token cannot see backend project ${BACKEND_SONAR_PROJECT_KEY}"; exit 1; }
      echo "Sonar smoke check OK âœ…"

# ---------- FRONTEND SONAR ----------
sonar:frontend:
  stage: sonar
  image: sonarsource/sonar-scanner-cli:latest
  needs: ["test:frontend", "sonar:smoke"]
  variables:
    SONAR_SCANNER_OPTS: "-Dsonar.qualitygate.wait=true"
    SONAR_TOKEN: "$SONAR_USER_TOKEN"
  before_script:
    - cd front-end
  script:
    - |
      set -euo pipefail
      sonar-scanner \
        -Dsonar.projectKey="${FRONTEND_SONAR_PROJECT_KEY}" \
        -Dsonar.projectName=frontend \
        -Dsonar.sources=src \
        -Dsonar.tests=src \
        -Dsonar.test.inclusions="**/*.spec.ts,**/*.spec.tsx,**/*.test.ts,**/*.test.tsx,**/*.spec.js,**/*.test.js" \
        -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info \
        -Dsonar.host.url="${SONAR_HOST_URL}" \
        -Dsonar.token="${SONAR_TOKEN}" \
        -Dsonar.qualitygate.wait=true

# ---------- BACKEND ----------
.default-gradle:
  image: gradle:8.10.0-jdk17-jammy
  cache:
    policy: pull-push
    key:
      files:
        - back-end/gradle/wrapper/gradle-wrapper.properties
        - back-end/build.gradle

    paths:
      - ".gradle/caches"
      - ".gradle/wrapper"
      - "${SONAR_USER_HOME}/cache"
  before_script:
    - cd back-end
    - java -version
    - gradle --version

build:backend:
  stage: build
  extends: .default-gradle
  script:
    # enable build cache & parallel to speed up
    - gradle --no-daemon --build-cache --parallel assemble
  artifacts:
    paths:
      - back-end/build/libs/*.jar
    expire_in: 3 days

test:backend:
  stage: test
  extends: .default-gradle
  needs: [ "build:backend" ]
  script:
    - gradle --no-daemon --build-cache --parallel test jacocoTestReport
  artifacts:
    when: always
    reports:
      junit: back-end/build/test-results/test/*.xml
    paths:
      - back-end/build/reports/jacoco/test/jacocoTestReport.xml

sonar:backend:
  stage: sonar
  extends: .default-gradle
  needs: ["test:backend", "sonar:smoke"]
  variables:
    SONAR_TOKEN: "$SONAR_USER_TOKEN"
  before_script:
    # gradle:8.10.0-jdk17-jammy is Debian/Ubuntu-based -> use apt-get
    - apt-get update -y >/dev/null && apt-get install -y curl >/dev/null
    - cd back-end
  script:
    - |
      set -euo pipefail
      gradle --no-daemon --build-cache --parallel clean build jacocoTestReport sonarqube \
        -Dsonar.host.url="${SONAR_HOST_URL}" \
        -Dsonar.token="${SONAR_TOKEN}" \
        -Dsonar.projectKey="${BACKEND_SONAR_PROJECT_KEY}" \
        -Dsonar.coverage.jacoco.xmlReportPaths=build/reports/jacoco/test/jacocoTestReport.xml \
        -Dsonar.java.binaries=build/classes/java/main,build/classes/kotlin/main

debug:net:
  image: busybox:1.36
  script:
    - echo "Expect to resolve 'sonarqube' on ci-net"
    - cat /etc/resolv.conf || true
    - cat /etc/hosts || true
    - nslookup sonarqube || ping -c 1 sonarqube || true

# ---------- OPTIONAL: Integration tests with real Postgres ----------
integration-test:backend:
  stage: integration-test
  image: gradle:8.10.0-jdk17-jammy
  services:
    - name: postgres:16-alpine
      alias: postgres
  variables:
    POSTGRES_DB: appdb
    POSTGRES_USER: app
    POSTGRES_PASSWORD: secret
    SPRING_DATASOURCE_URL: "jdbc:postgresql://postgres:5432/appdb"
    SPRING_DATASOURCE_USERNAME: "app"
    SPRING_DATASOURCE_PASSWORD: "secret"
    SPRING_FLYWAY_URL: "jdbc:postgresql://postgres:5432/appdb"
    SPRING_FLYWAY_USER: "app"
    SPRING_FLYWAY_PASSWORD: "secret"
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
    GRADLE_USER_HOME: "${CI_PROJECT_DIR}/.gradle"
  cache:
    policy: pull-push
    key:
      files:
        - back-end/gradle/wrapper/gradle-wrapper.properties
        - back-end/build.gradle

    paths:
      - ".gradle/caches"
      - ".gradle/wrapper"
  before_script:
    - apt-get update -y >/dev/null && apt-get install -y curl postgresql-client >/dev/null
    - echo "SONAR_HOST_URL=$SONAR_HOST_URL"
    - curl -sf "$SONAR_HOST_URL/api/system/status" | grep -q '"status":"UP"' || { echo "Sonar not UP"; exit 1; }
    - cd back-end
    - until pg_isready -h postgres -p 5432 -U "$POSTGRES_USER"; do echo "Waiting for Postgres..."; sleep 1; done
  script:
    - gradle --no-daemon --build-cache --parallel clean test jacocoTestReport
  rules:
    - if: '$RUN_INTEGRATION_TESTS == "true"'
