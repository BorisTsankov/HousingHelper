stages:
  - build
  - test
  - sonar
  - integration-test
  - docker
  - docker-aws

  - deploy

variables:
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  GIT_DEPTH: "0"
  GRADLE_USER_HOME: "${CI_PROJECT_DIR}/.gradle"

# -----------------------------
# Shared rules (branches logic)
# -----------------------------

# Build & test on feature/*, dev, main
.build-test-rules:
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^feature\//'
    - if: '$CI_COMMIT_BRANCH == "dev"'
    - if: '$CI_COMMIT_BRANCH == "main"'

# Sonar on dev, main and Merge Requests
.sonar-rules:
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev" || $CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# Only on dev and main
.dev-main-only-rules:
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev" || $CI_COMMIT_BRANCH == "main"'

# Only on main (for deploy)
.main-only-rules:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'


# -----------------------------
# Frontend (React / Vite) jobs
# -----------------------------
.default-node:
  image: node:20-bullseye
  cache:
    key:
      files:
        - front-end/package-lock.json
    paths:
      - front-end/node_modules/
      - front-end/.npm/
  before_script:
    - cd front-end
    - node -v
    - npm config set cache .npm --location=project
    - npm ci --no-audit --no-fund

build:frontend:
  stage: build
  extends:
    - .default-node
    - .build-test-rules
  script:
    - npm run build
  artifacts:
    paths:
      - front-end/dist
    expire_in: 3 days

test:frontend:
  stage: test
  extends:
    - .default-node
    - .build-test-rules
  needs: ["build:frontend"]
  script:
    - npx vitest run --coverage
    - test -f coverage/lcov.info || { echo "coverage/lcov.info missing"; exit 1; }
  artifacts:
    when: always
    reports:
      junit: front-end/junit/*.xml
    paths:
      - front-end/coverage/lcov.info
      - front-end/junit/

sonar:frontend:
  stage: sonar
  image: sonarsource/sonar-scanner-cli:latest
  extends:
    - .sonar-rules
  needs: ["test:frontend"]
  variables:
    SONAR_SCANNER_OPTS: "-Dsonar.qualitygate.wait=true"
    SONAR_TOKEN: "$SONAR_USER_TOKEN"
  before_script:
    - cd front-end
  script:
    - |
      set -euo pipefail
      sonar-scanner \
        -Dsonar.projectKey="${FRONTEND_SONAR_PROJECT_KEY}" \
        -Dsonar.projectName=frontend \
        -Dsonar.sources=src \
        -Dsonar.tests=src \
        -Dsonar.test.inclusions="**/*.spec.ts,**/*.spec.tsx,**/*.test.ts,**/*.test.tsx,**/*.spec.js,**/*.test.js" \
        -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info \
        -Dsonar.host.url="${SONAR_HOST_URL}" \
        -Dsonar.token="${SONAR_TOKEN}" \
        -Dsonar.qualitygate.wait=true

# -----------------------------
# Backend (Gradle / Spring Boot)
# -----------------------------
.default-gradle:
  image: gradle:8.10.0-jdk17-jammy
  cache:
    policy: pull-push
    key:
      files:
        - back-end/gradle/wrapper/gradle-wrapper.properties
        - back-end/build.gradle
    paths:
      - ".gradle/caches"
      - ".gradle/wrapper"
      - "${SONAR_USER_HOME}/cache"
  before_script:
    - cd back-end
    - java -version
    - gradle --version

build:backend:
  stage: build
  extends:
    - .default-gradle
    - .build-test-rules
  script:
    - gradle --no-daemon --build-cache --parallel assemble
  artifacts:
    paths:
      - back-end/build/libs/*.jar
    expire_in: 3 days

test:backend:
  stage: test
  extends:
    - .default-gradle
    - .build-test-rules
  needs: ["build:backend"]
  script:
    - gradle --no-daemon --build-cache --parallel test jacocoTestReport
  artifacts:
    when: always
    reports:
      junit: back-end/build/test-results/test/*.xml
    paths:
      - back-end/build/reports/jacoco/test/jacocoTestReport.xml
      - back-end/build/classes/java/main

sonar:backend:
  stage: sonar
  extends:
    - .default-gradle
    - .sonar-rules
  needs: ["test:backend"]
  variables:
    SONAR_TOKEN: "$SONAR_USER_TOKEN"
  before_script:
    - apt-get update -y >/dev/null && apt-get install -y curl >/dev/null
    - cd back-end
  script: |
    set -euo pipefail
    gradle --no-daemon --build-cache --parallel clean build jacocoTestReport sonar \
      -Dsonar.host.url="${SONAR_HOST_URL}" \
      -Dsonar.token="${SONAR_TOKEN}" \
      -Dsonar.projectKey="${BACKEND_SONAR_PROJECT_KEY}" \
      -Dsonar.sources=src/main/java \
      -Dsonar.tests=src/test/java \
      -Dsonar.java.binaries=build/classes/java/main \
      -Dsonar.coverage.jacoco.xmlReportPaths=build/reports/jacoco/test/jacocoTestReport.xml
    

# -----------------------------
# Integration tests (backend)
# -----------------------------
integration-test:backend:
  stage: integration-test
  image: gradle:8.10.0-jdk17-jammy
  services:
    - name: postgres:16-alpine
      alias: postgres
  variables:
    POSTGRES_DB: appdb
    POSTGRES_USER: app
    POSTGRES_PASSWORD: secret
    SPRING_DATASOURCE_URL: "jdbc:postgresql://postgres:5432/appdb"
    SPRING_DATASOURCE_USERNAME: "app"
    SPRING_DATASOURCE_PASSWORD: "secret"
    SPRING_FLYWAY_URL: "jdbc:postgresql://postgres:5432/appdb"
    SPRING_FLYWAY_USER: "app"
    SPRING_FLYWAY_PASSWORD: "secret"
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
    GRADLE_USER_HOME: "${CI_PROJECT_DIR}/.gradle"
  cache:
    policy: pull-push
    key:
      files:
        - back-end/gradle/wrapper/gradle-wrapper.properties
        - back-end/build.gradle
    paths:
      - ".gradle/caches"
      - ".gradle/wrapper"
  before_script:
    - apt-get update -y >/dev/null && apt-get install -y curl postgresql-client >/dev/null
    - echo "SONAR_HOST_URL=$SONAR_HOST_URL"
    - curl -sf "$SONAR_HOST_URL/api/system/status" | grep -q '"status":"UP"' || { echo "Sonar not UP"; exit 1; }
    - cd back-end
    - until pg_isready -h postgres -p 5432 -U "$POSTGRES_USER"; do echo "Waiting for Postgres..."; sleep 1; done
  script:
    - gradle --no-daemon --build-cache --parallel clean test jacocoTestReport
  extends:
    - .dev-main-only-rules
  # If you want a manual toggle via env var, use this instead:
  # rules:
  #   - if: '$CI_COMMIT_BRANCH == "dev" && $RUN_INTEGRATION_TESTS == "true"'
  #   - if: '$CI_COMMIT_BRANCH == "main" && $RUN_INTEGRATION_TESTS == "true"'

# -----------------------------
# Docker image build (monorepo)
# -----------------------------
docker:build-backend:
  stage: docker
  image: docker:24.0.9
  services:
    - name: docker:24.0.9-dind
      alias: docker
      command: ["--tls=false", "--host=tcp://0.0.0.0:2375"]
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_DRIVER: overlay2
    DOCKER_CONFIG: "/tmp/docker"
  needs:
    - sonar:backend
    - integration-test:backend
  script:
    - echo "Logging in to Docker Hub..."
    - mkdir -p "$DOCKER_CONFIG"
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

    - echo "Building backend image..."
    - docker build -t "$DOCKERHUB_USERNAME/housinghelper-backend:${CI_COMMIT_SHORT_SHA}" back-end

    - |
      if [ "$CI_COMMIT_BRANCH" = "dev" ] || [ "$CI_COMMIT_BRANCH" = "main" ]; then
        docker tag "$DOCKERHUB_USERNAME/housinghelper-backend:${CI_COMMIT_SHORT_SHA}" \
                   "$DOCKERHUB_USERNAME/housinghelper-backend:${CI_COMMIT_BRANCH}"
      fi

    - docker push "$DOCKERHUB_USERNAME/housinghelper-backend:${CI_COMMIT_SHORT_SHA}"

    - |
      if [ "$CI_COMMIT_BRANCH" = "dev" ] || [ "$CI_COMMIT_BRANCH" = "main" ]; then
        docker push "$DOCKERHUB_USERNAME/housinghelper-backend:${CI_COMMIT_BRANCH}"
      fi

  extends:
    - .dev-main-only-rules


docker:build-frontend:
  stage: docker
  image: docker:24.0.9
  services:
    - name: docker:24.0.9-dind
      alias: docker
      command: ["--tls=false", "--host=tcp://0.0.0.0:2375"]
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_DRIVER: overlay2
    DOCKER_CONFIG: "/tmp/docker"
  needs:
    - sonar:frontend
  script:
    - echo "Logging in to Docker Hub..."
    - mkdir -p "$DOCKER_CONFIG"
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

    - echo "Building frontend image..."
    - docker build -t "$DOCKERHUB_USERNAME/housinghelper-frontend:${CI_COMMIT_SHORT_SHA}" front-end

    - |
      if [ "$CI_COMMIT_BRANCH" = "dev" ] || [ "$CI_COMMIT_BRANCH" = "main" ]; then
        docker tag "$DOCKERHUB_USERNAME/housinghelper-frontend:${CI_COMMIT_SHORT_SHA}" \
                   "$DOCKERHUB_USERNAME/housinghelper-frontend:${CI_COMMIT_BRANCH}"
      fi

    - docker push "$DOCKERHUB_USERNAME/housinghelper-frontend:${CI_COMMIT_SHORT_SHA}"

    - |
      if [ "$CI_COMMIT_BRANCH" = "dev" ] || [ "$CI_COMMIT_BRANCH" = "main" ]; then
        docker push "$DOCKERHUB_USERNAME/housinghelper-frontend:${CI_COMMIT_BRANCH}"
      fi

  extends:
    - .dev-main-only-rules


docker:ecr-backend:
  stage: docker-aws
  image: docker:24.0.9
  services:
    - name: docker:24.0.9-dind
      alias: docker
      command: ["--tls=false", "--host=tcp://0.0.0.0:2375"]
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_DRIVER: overlay2
    DOCKER_CONFIG: "/tmp/docker"
  needs:
    - sonar:backend
    - integration-test:backend
  script:
    - apk add --no-cache aws-cli

    - echo "Logging in to Amazon ECR..."
    - aws ecr get-login-password --region "$AWS_DEFAULT_REGION" \
      | docker login --username AWS --password-stdin "$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com"

    - echo "Building backend image for ECR..."
    - docker build -t "$ECR_BACKEND_REPO:${CI_COMMIT_SHORT_SHA}" back-end

    - echo "Tagging backend image for ECR (commit SHA)..."
    - docker tag "$ECR_BACKEND_REPO:${CI_COMMIT_SHORT_SHA}" "$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$ECR_BACKEND_REPO:${CI_COMMIT_SHORT_SHA}"

    - |
      if [ "$CI_COMMIT_BRANCH" = "dev" ] || [ "$CI_COMMIT_BRANCH" = "main" ]; then
        echo "Tagging backend image for ECR (branch tag: $CI_COMMIT_BRANCH)..."
        docker tag "$ECR_BACKEND_REPO:${CI_COMMIT_SHORT_SHA}" \
          "$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$ECR_BACKEND_REPO:${CI_COMMIT_BRANCH}"
      fi

    - echo "Pushing backend image to ECR (commit SHA)..."
    - docker push "$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$ECR_BACKEND_REPO:${CI_COMMIT_SHORT_SHA}"

    - |
      if [ "$CI_COMMIT_BRANCH" = "dev" ] || [ "$CI_COMMIT_BRANCH" = "main" ]; then
        echo "Pushing backend image to ECR (branch tag: $CI_COMMIT_BRANCH)..."
        docker push "$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$ECR_BACKEND_REPO:${CI_COMMIT_BRANCH}"
      fi

  extends:
    - .dev-main-only-rules


docker:ecr-frontend:
  stage: docker-aws
  image: docker:24.0.9
  services:
    - name: docker:24.0.9-dind
      alias: docker
      command: ["--tls=false", "--host=tcp://0.0.0.0:2375"]
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_DRIVER: overlay2
    DOCKER_CONFIG: "/tmp/docker"
  needs:
    - sonar:frontend
  script:
    - apk add --no-cache aws-cli

    - echo "Logging in to Amazon ECR..."
    - aws ecr get-login-password --region "$AWS_DEFAULT_REGION" \
      | docker login --username AWS --password-stdin "$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com"

    - echo "Building frontend image for ECR..."
    - docker build -t "$ECR_FRONTEND_REPO:${CI_COMMIT_SHORT_SHA}" front-end

    - echo "Tagging frontend image for ECR (commit SHA)..."
    - docker tag "$ECR_FRONTEND_REPO:${CI_COMMIT_SHORT_SHA}" "$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$ECR_FRONTEND_REPO:${CI_COMMIT_SHORT_SHA}"

    - |
      if [ "$CI_COMMIT_BRANCH" = "dev" ] || [ "$CI_COMMIT_BRANCH" = "main" ]; then
        echo "Tagging frontend image for ECR (branch tag: $CI_COMMIT_BRANCH)..."
        docker tag "$ECR_FRONTEND_REPO:${CI_COMMIT_SHORT_SHA}" \
          "$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$ECR_FRONTEND_REPO:${CI_COMMIT_BRANCH}"
      fi

    - echo "Pushing frontend image to ECR (commit SHA)..."
    - docker push "$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$ECR_FRONTEND_REPO:${CI_COMMIT_SHORT_SHA}"

    - |
      if [ "$CI_COMMIT_BRANCH" = "dev" ] || [ "$CI_COMMIT_BRANCH" = "main" ]; then
        echo "Pushing frontend image to ECR (branch tag: $CI_COMMIT_BRANCH)..."
        docker push "$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$ECR_FRONTEND_REPO:${CI_COMMIT_BRANCH}"
      fi

  extends:
    - .dev-main-only-rules


deploy:azure-containerapps:
  stage: deploy
  image: mcr.microsoft.com/azure-cli:2.64.0
  needs:
    - docker:build-backend
    - docker:build-frontend
  extends:
    - .main-only-rules
  script:
    - echo "Logging in to Azure..."
    - az login --service-principal \
      --username "$AZURE_CLIENT_ID" \
      --password "$AZURE_CLIENT_SECRET" \
      --tenant "$AZURE_TENANT_ID"
    - az account set --subscription "$AZURE_SUBSCRIPTION_ID"

    - echo "Updating backend Container App image..."
    - az containerapp update \
      --name housinghelper-backend \
      --resource-group housinghelper-rg \
      --image "$DOCKERHUB_USERNAME/housinghelper-backend:main"

    - echo "Updating frontend Container App image..."
    - az containerapp update \
      --name housinghelper-frontend \
      --resource-group housinghelper-rg \
      --image "$DOCKERHUB_USERNAME/housinghelper-frontend:main"

    - echo "Deployment to Azure Container Apps completed."
  environment:
    name: production
