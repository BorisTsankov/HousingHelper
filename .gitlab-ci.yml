# Global
stages:
  - build
  - test
  - sonar
  - integration-test  # optional, runs only if you trigger it

variables:
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  GIT_DEPTH: "0"
  GRADLE_USER_HOME: "${CI_PROJECT_DIR}/.gradle"
  FRONTEND_SONAR_PROJECT_KEY: "I547859_housinghelper_ae8e7364-5047-4633-b1b8-b09df4130bef"
  BACKEND_SONAR_PROJECT_KEY: "I547859_housinghelper_backend"

# ---------- FRONTEND ----------
.default-node:
  image: node:20-bullseye
  cache:
    key: "npm-${CI_COMMIT_REF_SLUG}"
    paths:
      - front-end/node_modules/
  before_script:
    - cd front-end
    - node -v
    - npm ci

build:frontend:
  stage: build
  extends: .default-node
  script:
    - npm run build
  artifacts:
    paths:
      - front-end/dist
    expire_in: 3 days

test:frontend:
  stage: test
  extends: .default-node
  needs: [ "build:frontend" ]
  script:
    - if npm run | grep -qE '^[[:space:]]*test'; then npm run test -- --ci --watchAll=false --coverage; else echo "No npm test script. Skipping."; fi
  artifacts:
    when: always
    reports:
      junit: front-end/junit/*.xml
    paths:
      - front-end/coverage/lcov.info

sonar:frontend:
  stage: sonar
  image: sonarsource/sonar-scanner-cli:latest
  needs: ["test:frontend"]
  variables:
    SONAR_SCANNER_OPTS: "-Dsonar.qualitygate.wait=true"
    SONAR_TOKEN: "$SONAR_TOKEN_FRONT"     # <<< map FRONT token here
  before_script:
    - cd front-end
    - |
      set -euo pipefail
      echo "Using SONAR_HOST_URL=${SONAR_HOST_URL}"
      for i in $(seq 1 20); do
        if curl -sf --retry 5 --retry-connrefused -u "${SONAR_TOKEN}:" \
           "${SONAR_HOST_URL}/api/system/health" | grep -q '"status":"GREEN"'; then
          echo "SonarQube is healthy."; break
        fi
        echo "Waiting for SonarQube... ($i/20)"; sleep 2
        [ "$i" -eq 20 ] && { echo "SonarQube did not become healthy in time"; exit 1; }
      done
    - |
      set -euo pipefail
      curl -sf -u "${SONAR_TOKEN}:" \
        "${SONAR_HOST_URL}/api/projects/search?projects=${FRONTEND_SONAR_PROJECT_KEY}" \
        | grep -q "\"key\":\"${FRONTEND_SONAR_PROJECT_KEY}\"" \
        || { echo "Token cannot see project ${FRONTEND_SONAR_PROJECT_KEY}"; exit 1; }
  script:
    - |
      sonar-scanner \
        -Dsonar.projectKey="${FRONTEND_SONAR_PROJECT_KEY}" \
        -Dsonar.projectName=frontend \
        -Dsonar.sources=src \
        -Dsonar.tests=src \
        -Dsonar.test.inclusions="**/*.spec.ts,**/*.spec.tsx,**/*.test.ts,**/*.test.tsx,**/*.spec.js,**/*.test.js" \
        -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info \
        -Dsonar.host.url="${SONAR_HOST_URL}" \
        -Dsonar.token="${SONAR_TOKEN}" \
        -Dsonar.qualitygate.wait=true



# ---------- BACKEND ----------
.default-gradle:
  image: gradle:8.10.0-jdk17-jammy
  cache:
    policy: pull-push
    key: "gradle-${CI_COMMIT_REF_SLUG}"
    paths:
      - ".gradle/caches"
      - ".gradle/wrapper"
      - "${SONAR_USER_HOME}/cache"
  before_script:
    - cd back-end
    - java -version
    - gradle --version

build:backend:
  stage: build
  extends: .default-gradle
  script:
    - gradle assemble
  artifacts:
    paths:
      - back-end/build/libs/*.jar
    expire_in: 3 days

test:backend:
  stage: test
  extends: .default-gradle
  needs: [ "build:backend" ]
  script:
    - gradle test jacocoTestReport
  artifacts:
    when: always
    reports:
      junit: back-end/build/test-results/test/*.xml
    paths:
      - back-end/build/reports/jacoco/test/jacocoTestReport.xml

sonar:backend:
  stage: sonar
  extends: .default-gradle
  needs: ["test:backend"]
  variables:
    SONAR_TOKEN: "$SONAR_TOKEN_BACK"      # <<< map BACK token here
  before_script:
    - apk add --no-cache curl >/dev/null 2>&1 || true
    - echo "SONAR_HOST_URL=$SONAR_HOST_URL"
    - curl -sf "$SONAR_HOST_URL/api/system/health" || { echo "Sonar unreachable"; exit 1; }
    - cd front-end   # or back-end in the backend job
    - cd back-end
    - |
      set -euo pipefail
      echo "Using SONAR_HOST_URL=${SONAR_HOST_URL}"
      for i in $(seq 1 20); do
        if curl -sf --retry 5 --retry-connrefused -u "${SONAR_TOKEN}:" \
           "${SONAR_HOST_URL}/api/system/health" | grep -q '"status":"GREEN"'; then
          echo "SonarQube is healthy."; break
        fi
        echo "Waiting for SonarQube... ($i/20)"; sleep 2
        [ "$i" -eq 20 ] && { echo "SonarQube did not become healthy in time"; exit 1; }
      done
    - |
      set -euo pipefail
      curl -sf -u "${SONAR_TOKEN}:" \
        "${SONAR_HOST_URL}/api/projects/search?projects=${BACKEND_SONAR_PROJECT_KEY}" \
        | grep -q "\"key\":\"${BACKEND_SONAR_PROJECT_KEY}\"" \
        || { echo "Token cannot see project ${BACKEND_SONAR_PROJECT_KEY}"; exit 1; }
  script:
    - |
      set -euo pipefail
      gradle --no-daemon clean build jacocoTestReport sonarqube \
        -Dsonar.host.url="${SONAR_HOST_URL}" \
        -Dsonar.token="${SONAR_TOKEN}" \
        -Dsonar.projectKey="${BACKEND_SONAR_PROJECT_KEY}" \
        -Dsonar.coverage.jacoco.xmlReportPaths=build/reports/jacoco/test/jacocoTestReport.xml \
        -Dsonar.java.binaries=build/classes/java/main,build/classes/kotlin/main

# ---------- OPTIONAL: Integration tests with real Postgres ----------
integration-test:backend:
  stage: integration-test
  image: gradle:8.10.0-jdk17-jammy
  services:
    - name: postgres:16-alpine
      alias: postgres
  variables:
    POSTGRES_DB: appdb
    POSTGRES_USER: app
    POSTGRES_PASSWORD: secret
    SPRING_DATASOURCE_URL: "jdbc:postgresql://postgres:5432/appdb"
    SPRING_DATASOURCE_USERNAME: "app"
    SPRING_DATASOURCE_PASSWORD: "secret"
    SPRING_FLYWAY_URL: "jdbc:postgresql://postgres:5432/appdb"
    SPRING_FLYWAY_USER: "app"
    SPRING_FLYWAY_PASSWORD: "secret"
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
    GRADLE_USER_HOME: "${CI_PROJECT_DIR}/.gradle"
  cache:
    policy: pull-push
    key: "gradle-int-${CI_COMMIT_REF_SLUG}"
    paths:
      - ".gradle/caches"
      - ".gradle/wrapper"
  before_script:
    - apk add --no-cache curl >/dev/null 2>&1 || true
    - echo "SONAR_HOST_URL=$SONAR_HOST_URL"
    - curl -sf "$SONAR_HOST_URL/api/system/health" || { echo "Sonar unreachable"; exit 1; }
    - cd back-end   # or back-end in the backend job
    - apt-get update -y >/dev/null && apt-get install -y postgresql-client >/dev/null
    - until pg_isready -h postgres -p 5432 -U "$POSTGRES_USER"; do echo "Waiting for Postgres..."; sleep 1; done
    - cd back-end
  script:
    - gradle clean test jacocoTestReport
  rules:
    - if: '$RUN_INTEGRATION_TESTS == "true"'   # run manually or via schedule/variable
