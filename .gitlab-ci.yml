variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"

stages:
  - build
  - test
  - sonarqube-check

# ---------- shared anchors ----------
.default-node:
  image: node:20-bullseye   # Node 20 to satisfy vite/react-router engines
  cache:
    key: npm-cache
    paths:
      - front-end/node_modules/
  before_script:
    - cd front-end
    - node -v
    - npm ci

.default-gradle:
  image: eclipse-temurin:17-jdk   # JDK 17 to match Gradle toolchain requirement
  services:
    - name: postgres:16-alpine
      alias: postgres
  variables:
    GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"

    # Postgres service credentials
    POSTGRES_DB: appdb
    POSTGRES_USER: app
    POSTGRES_PASSWORD: secret

    # Spring points to the Postgres service via Docker DNS
    SPRING_DATASOURCE_URL: "jdbc:postgresql://postgres:5432/appdb"
    SPRING_DATASOURCE_USERNAME: "app"
    SPRING_DATASOURCE_PASSWORD: "secret"

    # Keep if Flyway is configured separately; remove if it reuses the datasource
    SPRING_FLYWAY_URL: "jdbc:postgresql://postgres:5432/appdb"
    SPRING_FLYWAY_USER: "app"
    SPRING_FLYWAY_PASSWORD: "secret"
  cache:
    key: gradle-cache
    paths:
      - .gradle/wrapper
      - .gradle/caches
  before_script:
    - cd back-end
    - java -version
    - chmod +x ./gradlew
    # Wait for Postgres to accept connections
    - apt-get update -y >/dev/null && apt-get install -y postgresql-client >/dev/null
    - until pg_isready -h postgres -p 5432 -U "$POSTGRES_USER"; do echo "Waiting for Postgres..."; sleep 1; done

# ================= FRONT-END =================
build:frontend:
  stage: build
  extends: [.default-node]
  script:
    - npm run build
  artifacts:
    paths:
      - front-end/dist   # Vite default output
    expire_in: 3 days

test:frontend:
  stage: test
  extends: [.default-node]
  needs: ["build:frontend"]
  script:
    # Run tests only if a "test" script exists; otherwise skip gracefully
    - if npm run | grep -qE '^[[:space:]]*test'; then npm run test -- --ci --watchAll=false; else echo "No npm test script. Skipping."; fi
  artifacts:
    when: always
    # If you export JUnit from your test runner, point this to the correct path
    reports:
      junit: front-end/junit/*.xml

sonarqube-check:frontend:
  stage: sonarqube-check
  image: alpine:3.20
  needs: ["test:frontend"]
  script:
    - echo "Frontend Sonar placeholder — replace with 'sonar-scanner' if configured."

# ================= BACK-END =================
build:backend:
  stage: build
  extends: [.default-gradle]
  script:
    - ./gradlew assemble
  artifacts:
    paths:
      - back-end/build/libs/*.jar
    expire_in: 3 days

test:backend:
  stage: test
  extends: [.default-gradle]
  needs: ["build:backend"]
  script:
    - ./gradlew test
  artifacts:
    when: always
    reports:
      junit: back-end/build/test-results/test/*.xml

sonarqube-check:backend:
  stage: sonarqube-check
  image: alpine:3.20
  needs: ["test:backend"]
  script:
    - echo "Backend Sonar placeholder — replace with './gradlew sonarqube' when ready."
