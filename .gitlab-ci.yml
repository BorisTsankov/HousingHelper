variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"

stages:
  - build
  - test
  - sonarqube-check

# ---------- shared anchors ----------
.default-node:
  image: node:18-bullseye
  cache:
    key: npm-cache
    paths:
      - front-end/node_modules/
  before_script:
    - cd front-end
    - node -v
    - npm ci

.default-gradle:
  image: eclipse-temurin:21-jdk
  variables:
    GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"
  cache:
    key: gradle-cache
    paths:
      - .gradle/wrapper
      - .gradle/caches
  before_script:
    - cd back-end
    - java -version
    - chmod +x ./gradlew

# ================= FRONT-END =================
build:frontend:
  stage: build
  extends: [.default-node]
  script:
    - npm run build
  artifacts:
    paths:
      - front-end/build
    expire_in: 3 days

test:frontend:
  stage: test
  extends: [.default-node]
  needs: ["build:frontend"]
  script:
    - npm test -- --ci --watchAll=false
  artifacts:
    when: always
    reports:
      junit: front-end/junit/*.xml  # optional: adjust if you export JUnit

sonarqube-check:frontend:
  stage: sonarqube-check
  image: alpine:3.20
  needs: ["test:frontend"]
  script:
    - echo "Frontend Sonar step placeholder (replace with real sonar-scanner if needed)."

# ================= BACK-END =================
build:backend:
  stage: build
  extends: [.default-gradle]
  script:
    - ./gradlew assemble
  artifacts:
    paths:
      - back-end/build/libs/*.jar
    expire_in: 3 days

test:backend:
  stage: test
  extends: [.default-gradle]
  needs: ["build:backend"]
  script:
    - ./gradlew test
  artifacts:
    when: always
    reports:
      junit: back-end/build/test-results/test/*.xml

sonarqube-check:backend:
  stage: sonarqube-check
  image: alpine:3.20
  needs: ["test:backend"]
  script:
    - echo "Backend Sonar step placeholder (replace with ./gradlew sonarqube or sonar-scanner)."

# ---------- optional rules (run on any branch & MRs) ----------
# Uncomment if you want to limit to MRs / main only.
# default:
#   rules:
#     - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
#     - if: '$CI_COMMIT_BRANCH == "main"'
