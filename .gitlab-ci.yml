variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"
  # Cache dirs (adjust if needed)
  GRADLE_USER_HOME: "C:\\Windows\\System32\\config\\systemprofile\\.gradle"
  NPM_CACHE_FOLDER: "$env:LOCALAPPDATA\\npm-cache"

stages:
  - build
  - test
  - sonarqube-check

# Reusable Java + Gradle wrapper detection (monorepo-safe)
.before_java: &before_java
  before_script:
    - |
      # --- PowerShell, Java setup ---
      Write-Host "CWD          : $PWD"
      Write-Host "Project dir  : $env:CI_PROJECT_DIR"
      Set-Location $env:CI_PROJECT_DIR

      $jdk = Get-ChildItem 'C:\Program Files\Eclipse Adoptium' -Directory -Filter 'jdk*' |
        Sort-Object Name -Descending |
        Select-Object -First 1 -ExpandProperty FullName
      if (-not $jdk) { throw "No JDK found under C:\Program Files\Eclipse Adoptium" }
      $env:JAVA_HOME = $jdk
      $env:Path = "$env:JAVA_HOME\bin;$env:Path"
      Write-Host "Using JAVA_HOME = $env:JAVA_HOME"
      java -version | Write-Host

# Reusable Node detection
.before_node: &before_node
  before_script:
    - |
      Write-Host "CWD          : $PWD"
      Write-Host "Project dir  : $env:CI_PROJECT_DIR"
      Set-Location $env:CI_PROJECT_DIR

      # Try common Node locations on Windows runners
      $possibleNode = @(
        "$env:ProgramFiles\nodejs\node.exe",
        "$env:ProgramFiles(x86)\nodejs\node.exe",
        "$env:UserProfile\scoop\apps\nodejs\current\node.exe",
        "$env:ChocolateyInstall\bin\node.exe"
      ) | Where-Object { Test-Path $_ } | Select-Object -First 1

      if ($possibleNode) {
        $env:Path = (Split-Path $possibleNode) + ";" + $env:Path
      }

      if (-not (Get-Command node -ErrorAction SilentlyContinue)) {
        throw "Node.js not found on the runner. Please install Node (e.g., 'choco install nodejs-lts') and re-run."
      }

      node -v | Write-Host
      npm -v  | Write-Host

# ----------------- BACKEND JOBS (Gradle in back-end/) -----------------

backend:build:
  stage: build
  <<: *before_java
  cache:
    key: "gradle-cache"
    paths:
      - $GRADLE_USER_HOME\caches\
      - $GRADLE_USER_HOME\wrapper\
  script:
    - |
      $env:PROJECT_DIR = Join-Path $env:CI_PROJECT_DIR 'back-end'
      if (-not (Test-Path (Join-Path $env:PROJECT_DIR 'gradlew.bat'))) {
        throw "back-end/gradlew.bat not found. Ensure the wrapper is committed in back-end/."
      }
      Push-Location $env:PROJECT_DIR
      & ".\gradlew.bat" --version
      & ".\gradlew.bat" assemble --stacktrace --info
      Pop-Location
  rules:
    - changes:
        - back-end/**

backend:test:
  stage: test
  needs: ["backend:build"]
  <<: *before_java
  cache:
    key: "gradle-cache"
    paths:
      - $GRADLE_USER_HOME\caches\
      - $GRADLE_USER_HOME\wrapper\
  script:
    - |
      $env:PROJECT_DIR = Join-Path $env:CI_PROJECT_DIR 'back-end'
      Push-Location $env:PROJECT_DIR
      & ".\gradlew.bat" test --stacktrace --info
      Pop-Location
  artifacts:
    when: always
    paths:
      - back-end/build/reports/tests/
    expire_in: 1 week
  rules:
    - changes:
        - back-end/**

# ----------------- FRONTEND JOBS (Node in front-end/) -----------------

frontend:build:
  stage: build
  <<: *before_node
  cache:
    key: "npm-cache"
    paths:
      - $NPM_CACHE_FOLDER
      - front-end\node_modules\
  script:
    - |
      $env:PROJECT_DIR = Join-Path $env:CI_PROJECT_DIR 'front-end'
      Push-Location $env:PROJECT_DIR

      # npm ci for reproducible installs
      npm ci --cache "$env:NPM_CACHE_FOLDER" --prefer-offline
      npm run build
      Pop-Location
  rules:
    - changes:
        - front-end/**

frontend:test:
  stage: test
  needs: ["frontend:build"]
  <<: *before_node
  cache:
    key: "npm-cache"
    paths:
      - $NPM_CACHE_FOLDER
      - front-end\node_modules\
  script:
    - |
      $env:PROJECT_DIR = Join-Path $env:CI_PROJECT_DIR 'front-end'
      Push-Location $env:PROJECT_DIR
      npm test -- --ci
      Pop-Location
  artifacts:
    when: always
    paths:
      - front-end/coverage/
      - front-end/junit.xml
    expire_in: 1 week
  rules:
    - changes:
        - front-end/**

# --------------- Sonar (example placeholder) ----------------

sonarqube-check:
  stage: sonarqube-check
  needs: ["backend:test", "frontend:test"]
  script:
    - echo "Replace with real Sonar steps (scanner, tokens, etc.)"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
