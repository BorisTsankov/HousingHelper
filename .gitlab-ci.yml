stages:
  - build
  - test
  - sonar
  - integration-test

variables:
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  GIT_DEPTH: "0"
  GRADLE_USER_HOME: "${CI_PROJECT_DIR}/.gradle"
  FRONTEND_SONAR_PROJECT_KEY: "I547859_housinghelper_ae8e7364-5047-4633-b1b8-b09df4130bef"
  BACKEND_SONAR_PROJECT_KEY: "I547859_housinghelper_backend"

.default-node:
  image: node:20-bullseye
  cache:
    key:
      files:
        - front-end/package-lock.json
    paths:
      - front-end/node_modules/
      - front-end/.npm/
  before_script:
    - cd front-end
    - node -v
    - npm config set cache .npm --location=project
    - npm ci --no-audit --no-fund

build:frontend:
  stage: build
  extends: .default-node
  script:
    - npm run build
  artifacts:
    paths:
      - front-end/dist
    expire_in: 3 days

test:frontend:
  stage: test
  extends: .default-node
  needs: ["build:frontend"]
  script:
    - cd front-end
    - node -v
    - npm config set cache .npm --location=project
    - npm ci --no-audit --no-fund
    - npx vitest run --coverage
    - test -f coverage/lcov.info || { echo "coverage/lcov.info missing"; exit 1; }
  artifacts:
    when: always
    reports:
      junit: front-end/junit/*.xml
    paths:
      - front-end/coverage/lcov.info
      - front-end/junit/


#sonar:whoami:
#  stage: sonar
#  image: curlimages/curl:8.10.1
#  variables:
#    SONAR_TOKEN: "$SONAR_USER_TOKEN"
#  script: |
#    set -euo pipefail
#    echo "Host: ${SONAR_HOST_URL}"
#    echo "Validate token:"
#    curl -s -u "${SONAR_TOKEN}:" "${SONAR_HOST_URL}/api/authentication/validate"; echo
#    echo "Current user:"
#    curl -s -u "${SONAR_TOKEN}:" "${SONAR_HOST_URL}/api/users/current"; echo
#    echo "Frontend visible? (HTTP 200 expected)"
#    curl -s -o /dev/null -w "%{http_code}\n" -u "${SONAR_TOKEN}:" \
#      "${SONAR_HOST_URL}/api/components/show?component=${FRONTEND_SONAR_PROJECT_KEY}"
#    echo "Backend visible? (HTTP 200 expected)"
#    curl -s -o /dev/null -w "%{http_code}\n" -u "${SONAR_TOKEN}:" \
#      "${SONAR_HOST_URL}/api/components/show?component=${BACKEND_SONAR_PROJECT_KEY}"
#
#
##Sonar SMOKE CHECK
#sonar:smoke:
#  stage: sonar
#  image: curlimages/curl:8.10.1
#  variables:
#    SONAR_TOKEN: "$SONAR_USER_TOKEN"
#  script: |
#    set -euo pipefail
#    curl -sf "${SONAR_HOST_URL}/api/system/status" | grep -q '"status":"UP"'
#    curl -sf -u "${SONAR_TOKEN}:" "${SONAR_HOST_URL}/api/authentication/validate" | grep -q '"valid":true'
#
#    check () {
#      local key="$1"
#      code=$(curl -s -o /dev/null -w "%{http_code}" -u "${SONAR_TOKEN}:" \
#        "${SONAR_HOST_URL}/api/components/show?component=${key}")
#      test "$code" = "200" || { echo "Token cannot browse ${key} (HTTP $code)"; exit 1; }
#    }
#
#    check "${FRONTEND_SONAR_PROJECT_KEY}"
#    check "${BACKEND_SONAR_PROJECT_KEY}"
#    echo "Sonar smoke check OK"


sonar:frontend:
  stage: sonar
  image: sonarsource/sonar-scanner-cli:latest
  needs: ["test:frontend"]    #, "sonar:smoke"
  variables:
    SONAR_SCANNER_OPTS: "-Dsonar.qualitygate.wait=true"
    SONAR_TOKEN: "$SONAR_USER_TOKEN"
  before_script:
    - cd front-end
  script:
    - |
      set -euo pipefail
      sonar-scanner \
        -Dsonar.projectKey="${FRONTEND_SONAR_PROJECT_KEY}" \
        -Dsonar.projectName=frontend \
        -Dsonar.sources=src \
        -Dsonar.tests=src \
        -Dsonar.test.inclusions="**/*.spec.ts,**/*.spec.tsx,**/*.test.ts,**/*.test.tsx,**/*.spec.js,**/*.test.js" \
        -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info \
        -Dsonar.host.url="${SONAR_HOST_URL}" \
        -Dsonar.token="${SONAR_TOKEN}" \
        -Dsonar.qualitygate.wait=true

.default-gradle:
  image: gradle:8.10.0-jdk17-jammy
  cache:
    policy: pull-push
    key:
      files:
        - back-end/gradle/wrapper/gradle-wrapper.properties
        - back-end/build.gradle

    paths:
      - ".gradle/caches"
      - ".gradle/wrapper"
      - "${SONAR_USER_HOME}/cache"
  before_script:
    - cd back-end
    - java -version
    - gradle --version

build:backend:
  stage: build
  extends: .default-gradle
  script:
    - gradle --no-daemon --build-cache --parallel assemble
  artifacts:
    paths:
      - back-end/build/libs/*.jar
    expire_in: 3 days

test:backend:
  stage: test
  extends: .default-gradle
  needs: [ "build:backend" ]
  script:
    - gradle --no-daemon --build-cache --parallel test jacocoTestReport
  artifacts:
    when: always
    reports:
      junit: back-end/build/test-results/test/*.xml
    paths:
      - back-end/build/reports/jacoco/test/jacocoTestReport.xml
      - back-end/build/classes/java/main


sonar:backend:
  stage: sonar
  extends: .default-gradle
  needs: ["test:backend"]  #, "sonar:smoke"
  variables:
    SONAR_TOKEN: "$SONAR_USER_TOKEN"
  before_script:
    - apt-get update -y >/dev/null && apt-get install -y curl >/dev/null
    - cd back-end
  script: |
    set -euo pipefail
    gradle --no-daemon --build-cache --parallel clean build jacocoTestReport sonar \
      -Dsonar.host.url="${SONAR_HOST_URL}" \
      -Dsonar.token="${SONAR_TOKEN}" \
      -Dsonar.projectKey="${BACKEND_SONAR_PROJECT_KEY}" \
      -Dsonar.sources=src/main/java \
      -Dsonar.tests=src/test/java \
      -Dsonar.java.binaries=build/classes/java/main \
      -Dsonar.coverage.jacoco.xmlReportPaths=build/reports/jacoco/test/jacocoTestReport.xml


#sonar:list-keys:
#  image: curlimages/curl:8.10.1
#  stage: sonar
#  variables:
#    SONAR_TOKEN: "$SONAR_USER_TOKEN"
#  script:
#    - |
#      set -euo pipefail
#      echo "Who am I?"
#      curl -sS -u "${SONAR_TOKEN}:" "${SONAR_HOST_URL}/api/users/current"; echo
#      echo "Project keys visible to this token:"
#      curl -sS -u "${SONAR_TOKEN}:" "${SONAR_HOST_URL}/api/projects/search?ps=500" \
#        | sed -n 's/.*"key":"\([^"]*\)".*/\1/p' | sort -u | head -n 200


#debug:net:
#  image: busybox:1.36
#  script:
#    - echo "Expect to resolve 'sonarqube' on ci-net"
#    - cat /etc/resolv.conf || true
#    - cat /etc/hosts || true
#    - nslookup sonarqube || ping -c 1 sonarqube || true

# optional: Integration tests with real Postgres
integration-test:backend:
  stage: integration-test
  image: gradle:8.10.0-jdk17-jammy
  services:
    - name: postgres:16-alpine
      alias: postgres
  variables:
    POSTGRES_DB: appdb
    POSTGRES_USER: app
    POSTGRES_PASSWORD: secret
    SPRING_DATASOURCE_URL: "jdbc:postgresql://postgres:5432/appdb"
    SPRING_DATASOURCE_USERNAME: "app"
    SPRING_DATASOURCE_PASSWORD: "secret"
    SPRING_FLYWAY_URL: "jdbc:postgresql://postgres:5432/appdb"
    SPRING_FLYWAY_USER: "app"
    SPRING_FLYWAY_PASSWORD: "secret"
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
    GRADLE_USER_HOME: "${CI_PROJECT_DIR}/.gradle"
  cache:
    policy: pull-push
    key:
      files:
        - back-end/gradle/wrapper/gradle-wrapper.properties
        - back-end/build.gradle

    paths:
      - ".gradle/caches"
      - ".gradle/wrapper"
  before_script:
    - apt-get update -y >/dev/null && apt-get install -y curl postgresql-client >/dev/null
    - echo "SONAR_HOST_URL=$SONAR_HOST_URL"
    - curl -sf "$SONAR_HOST_URL/api/system/status" | grep -q '"status":"UP"' || { echo "Sonar not UP"; exit 1; }
    - cd back-end
    - until pg_isready -h postgres -p 5432 -U "$POSTGRES_USER"; do echo "Waiting for Postgres..."; sleep 1; done
  script:
    - gradle --no-daemon --build-cache --parallel clean test jacocoTestReport
  rules:
    - if: '$RUN_INTEGRATION_TESTS == "true"'
