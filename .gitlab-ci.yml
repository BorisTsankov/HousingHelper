stages:
  - lint
  - test
  - build
  - package
  - deploy

# -------- Common anchors (DRY) --------
.default-docker:
  image: alpine:3.20
  before_script:
    - apk add --no-cache bash curl git coreutils

# Frontend base image (Node 18 LTS)
.node:
  image: node:18-bullseye
  cache:
    key:
      files:
        - frontend/package-lock.json
    paths:
      - frontend/node_modules/
  before_script:
    - cd frontend
    - node -v
    - npm ci

# Backend base image (Temurin JDK 21 + Gradle wrapper)
.gradle:
  image: eclipse-temurin:21-jdk
  variables:
    GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"
  cache:
    key:
      files:
        - backend/gradle/wrapper/gradle-wrapper.properties
        - backend/build.gradle         # (max 2 files in key)
      prefix: gradle-cache
    paths:
      - .gradle/wrapper
      - .gradle/caches
  before_script:
    - cd backend
    - java -version
    - chmod +x ./gradlew

# ==================== FRONTEND ====================
frontend:lint:
  stage: lint
  extends: [.node]
  script:
    - npm run lint

frontend:test:
  stage: test
  extends: [.node]
  needs: ["frontend:lint"]
  script:
    - npm test -- --ci --watchAll=false

frontend:build:
  stage: build
  extends: [.node]
  needs: ["frontend:test"]
  script:
    - npm run build
  artifacts:
    paths:
      - frontend/build
    expire_in: 3 days

# Build & push image only on main and tags
frontend:package:
  stage: package
  extends: [.default-docker]
  needs: ["frontend:build"]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG'   # any tag
    - when: never
  variables:
    IMAGE_NAME: "$CI_REGISTRY_IMAGE/frontend"
    IMAGE_TAG: "${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - docker build -t "$IMAGE_NAME:$IMAGE_TAG" -f frontend/Dockerfile .
    - docker push "$IMAGE_NAME:$IMAGE_TAG"

# ==================== BACKEND ====================
backend:lint:
  stage: lint
  extends: [.gradle]
  script:
    # Adjust to your linters; Spotless/Checkstyle examples:
    - ./gradlew spotlessCheck || ./gradlew checkstyleMain checkstyleTest

backend:test:
  stage: test
  extends: [.gradle]
  needs: ["backend:lint"]
  script:
    - ./gradlew test
  artifacts:
    when: always
    reports:
      junit: backend/build/test-results/test/*.xml

backend:build:
  stage: build
  extends: [.gradle]
  needs: ["backend:test"]
  script:
    - ./gradlew clean bootJar
  artifacts:
    paths:
      - backend/build/libs/*.jar
    expire_in: 3 days

# Build & push image only on main and tags
backend:package:
  stage: package
  extends: [.default-docker]
  needs: ["backend:build"]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG'   # any tag
    - when: never
  variables:
    IMAGE_NAME: "$CI_REGISTRY_IMAGE/backend"
    IMAGE_TAG: "${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - docker build -t "$IMAGE_NAME:$IMAGE_TAG" -f backend/Dockerfile .
    - docker push "$IMAGE_NAME:$IMAGE_TAG"

# ==================== DEPLOY ====================
deploy:staging:
  stage: deploy
  extends: [.default-docker]
  needs:
    - backend:package
    - frontend:package
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - when: never
  script:
    - echo "Deploy images $CI_REGISTRY_IMAGE/backend and $CI_REGISTRY_IMAGE/frontend to staging..."
